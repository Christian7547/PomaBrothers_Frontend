@{
    ViewData["Title"] = "Nueva entrega";
}

<h1 style="text-align:center">Nueva entrega</h1>

<hr />
<link rel="stylesheet" href="~/css/Forms.css">
<div class="container">
    <div class="row">
        <div class="col-md-6 mx-auto cardBPC">
            <br />
            <label class="fw-bold">Proveedor:</label>
            <select id="cmbSupplier" class="custom-select">
                <option value="" disabled selected>Seleccione el proveedor</option>
                @if (ViewBag.Suppliers != null)
                {
                    foreach (var supplier in (List<Supplier>)ViewBag.Suppliers)
                    {
                        <option value="@supplier.Id">@supplier.BussinesName</option>
                    }
                }
            </select>

            <br />
            <h3>Productos:</h3>
            <br />
            <div style="text-align:center">
                <button class="btn btncardD"
                    onclick=""
                    data-id=""
                    data-toggle="modal"
                    data-target="#mdlAddItem">
                Añadir Productos
            </button>
            </div>
            
            <br />
            <br />
            <div class="table-responsive">
                <table class="table ttablita mt-3" id="tableItems">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Modelo</th>
                            <th>Categoría</th>
                            <th>Precio de compra (Bs.)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <td></td>
                            <td></td>
                            <td>
                                <label for="lblTotal" class="control-label fw-bold">Total:</label>
                            </td>
                            <td>
                                <span id="lblTotal" class="fw-bold"></span>
                                <label class="fw-bold">Bs.</label>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <br />
            <br />
            <div style="text-align:center">
                <button data-toggle="modal" class="btn btncardD" data-target="#mdlWarehouse">
                    Guardar en almacén
                </button>
            </div>
            
            <br />
        </div>
    </div>
</div>

<div class="modal fade" id="mdlAddItem">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content Model2">
            <div class="modal-header">
                <h4>Agregar producto</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <form>
                            <div class="form-group">
                                <label for="txtName" class="control-label">Nombre del producto:</label>
                                <input type="text" id="txtName" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="txtSerie" class="control-label">Número de serie:</label>
                                <input type="text" id="txtSerie" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="txtDescription" class="control-label">Descripción:</label>
                                <textarea rows="8" id="txtDescription" class="form-control"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="control-label">Modelo:</label>
                                <div class="row">
                                    <div class="col-md-10">
                                        <input class="form-control" id="txtSearchModel" placeholder="Buscar Modelo..." />
                                        <ul id="showModels"></ul>
                                        <input id="txtModelId" hidden />
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-success fw-bold" type="button" data-toggle="modal" data-target="#newModel">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="txtPurchasePrice" class="control-label">Precio de compra:</label>
                                <input type="number" id="txtPurchasePrice" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="txtSalePrice" class="control-label">Precio de venta:</label>
                                <input type="number" id="txtSalePrice" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label class="control-label">Seleccione la categoría:</label>
                                <select class="form-select" id="categorySelected">
                                    @if (ViewBag.Categories != null)
                                    {
                                        @foreach (var category in (List<Category>)ViewBag.Categories)
                                        {
                                            <option value="@category.Id">@category.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="txtColor" class="control-label">Color:</label>
                                <input type="text" id="txtColor" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label for="imagenItem" class="control-label">Seleccione una imagen</label>
                                <input name="image" id="imagenItem" type="file" accept=".jpg" class="form-control-file" required />
                                <img src="" id="previa" width="400">
                            </div>
                            <div class="form-group">
                                <label class="control-label">Garantía:</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <input class="form-control" id="txtDurationWarranty" />
                                    </div>
                                    <div class="col-md-8">
                                        <select class="form-select" id="cmbTypeWarranty">
                                            <option value="" disabled selected>Seleccione tipo de garantía</option>
                                            <option value=""></option>
                                            <option value=""></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center justify-content-center modal-footer">
                <button type="button" class="btn bntIns" data-dismiss="modal" onclick="addItem()">Añadir</button>
                <button type="button" class="btn btnExitModelDV" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newModel">
    <div class=" modal-dialog modal-dialog-centered">
        <div class="modal-content detailsModal2">
            <div class="modal-header">
                <h4 class="modal-title">Añadir modelo</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="txtModel" class="col-form-label">Modelo:</label>
                        <input type="text" class="form-control" id="txtModel">
                    </div>
                    <div class="mb-3">
                        <label for="txtMarker" class="col-form-label">Marca:</label>
                        <input type="text" class="form-control" id="txtMarker">
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" role="switch" id="cbxCapacity" />
                            <label for="cbxCapacity" class="form-check-label">Añadir capacidad o tamaño</label>
                        </div>
                    </div>
                    <div class="form-group" id="capacityDiv">
                        <div class="row">
                            <div class="col-md-4">
                                <input class="form-control" id="txtCapacityOrSize" placeholder="Capacidad" />
                            </div>
                            <div class="col-md-8">
                                <select class="form-control" id="cmbMeasurementUnit">
                                    <option value="" disabled selected>Seleccione la unidad de medida</option>
                                    <option value="Litros">Litros</option>
                                    <option value="Kilogramos">Kilogramos</option>
                                    <option value="Pulgadas">Pulgadas</option>
                                    <option value="Watts">Watts</option>
                                    <option value="Metros/hora">M3/h </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <input type="submit" id="btnAdd" onclick="addModel()" data-dismiss="modal" class="btn bntIns" value="Añadir" />
                <button type="button" class="btn btnExitModelDV" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mdlWarehouse">
    <div class=" modal-dialog modal-dialog-centered">
        <div class="modal-content detailsModal2">
            <div class="modal-header">
                <h4 class="modal-title">Seleccione el almacén</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <select class="form-select" id="cmbWarehouse">
                        <option value="" disabled selected>...</option>
                        @if (ViewBag.Warehouses != null)
                        {
                            @foreach (var warehouse in (List<Warehouse>)ViewBag.Warehouses)
                            {
                                <option value="@warehouse.Id">@warehouse.Name</option>
                            }
                        }
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <input type="submit" id="btnSaveInWarehouse" onclick="sendData()" data-dismiss="modal" class="btn bntIns" value="Guardar" />
                <button type="button" class="btn btnExitModelDV" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{

    <script>

        const inputFile = document.querySelector('#imagenItem');
        const image = document.querySelector('#previa');

        var base64ImageSelected = "";
        async function encodeFileAsBase64URL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.addEventListener('loadend', () => {
                    resolve(reader.result);
                });
                reader.readAsDataURL(file);
            });
        };

         inputFile.addEventListener('input', async (event) => {
            console.log("se ejecuta el evento");
            const base64URL = await encodeFileAsBase64URL(inputFile.files[0]);
            base64ImageSelected = base64URL;
            console.log(base64URL);
            image.setAttribute('src', base64URL);
          });

        const txtSearchModel = document.getElementById('txtSearchModel');
        const showModels = document.getElementById('showModels');

        const capacityDiv = document.getElementById('capacityDiv');
        const cbxCapacity = document.getElementById('cbxCapacity');

        const txtName = document.getElementById('txtName');
        const txtSerie = document.getElementById('txtSerie');
        const txtDescription = document.getElementById('txtDescription');
        const txtModelId = document.getElementById('txtModelId');
        const txtPurchasePrice = document.getElementById('txtPurchasePrice');
        const txtSalePrice = document.getElementById('txtSalePrice');
        const categorySelected = document.getElementById('categorySelected');
        const txtColor = document.getElementById('txtColor');
        const txtDurationWarranty = document.getElementById('txtDurationWarranty');
        const cmbTypeWarranty = document.getElementById('cmbTypeWarranty');
        const imagenItem = document.getElementById('imagenItem');

        const cmbSupplier = document.getElementById('cmbSupplier');
        const tableItems = document.getElementById('tableItems');
        const lblTotal = document.getElementById('lblTotal');
        const cmbWarehouse = document.getElementById('cmbWarehouse');

        const objDelivery = {
            supplierId: 0,
            total: 0,
            items: [],
            purchasePrices: [],
            warehouseId: 0
        };

        const printItemsArray = [];

        document.addEventListener('DOMContentLoaded', () => {
            txtSearchModel.addEventListener('input', () => {
                showModels.style.display = 'block';
                searchModel(txtSearchModel.value);
            })
            capacityDiv.style.display = 'none';
        });

        cmbSupplier.addEventListener('change', () => {
            objDelivery.supplierId = parseInt(cmbSupplier.value);
        });

        cmbWarehouse.addEventListener('change', () => {
            objDelivery.warehouseId = parseInt(cmbWarehouse.value);
        })


        function addItem() {
            let item = {
                name: txtName.value,
                serie: txtSerie.value,
                description: txtDescription.value,
                price: parseFloat(txtSalePrice.value),
                color: txtColor.value,
                durationWarranty: txtDurationWarranty.value,
                typewarranty: cmbTypeWarranty.value,
                urlImage: base64ImageSelected,
                categoryId: categorySelected.value,
                status: 1,
                modelId: txtModelId.value

            };
            objDelivery.items.push(item);
            objDelivery.purchasePrices.push(parseFloat(txtPurchasePrice.value));
            objDelivery.total += parseFloat(txtPurchasePrice.value);
            AddItemsInTable();
            lblTotal.textContent = objDelivery.total;
        }

        function AddItemsInTable() {
            let item = {
                name: txtName.value,
                model: txtSearchModel.value,
                category: categorySelected.options[categorySelected.selectedIndex].textContent,
                price: parseFloat(txtPurchasePrice.value)
            }
            printItemsArray.push(item);
            printItems();
        }

        function printItems() {
            const tbody = tableItems.getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            for (let i = 0; i < printItemsArray.length; i++) {
                var newRow = tbody.insertRow();
                newRow.insertCell(0).textContent = printItemsArray[i].name;
                newRow.insertCell(1).textContent = printItemsArray[i].model;
                newRow.insertCell(2).textContent = printItemsArray[i].category;
                newRow.insertCell(3).textContent = printItemsArray[i].price;

                var removeButton = document.createElement("button");
                removeButton.classList.add("btn", "btnExitModelDV");
                removeButton.textContent = "Eliminar";
                removeButton.onclick = () => {
                    deleteItemOfTable(i);
                };
                newRow.insertCell(4).appendChild(removeButton);
            }
        }

        function deleteItemOfTable(index) {
            if (index >= 0 && index < printItemsArray.length) {
                objDelivery.total -= printItemsArray[index].price;
                lblTotal.textContent = objDelivery.total;
                printItemsArray.splice(index, 1);
                objDelivery.items.splice(index, 1);
                objDelivery.purchasePrices.splice(index, 1);
                printItems();
            }
        }

        function sendData() {
            console.log(objDelivery);

            objDelivery.items.forEach(item => {
                item.urlImage = item.urlImage.toString();
            });

            fetch('/Delivery/New', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(objDelivery)
            })
                .then(res => {
                    if (res.redirected) {
                        window.location.href = res.url;
                        alert('Transacción exitosa');
                    }
                })
                .then(data => console.log(data))
                .catch(error => console.error(error))
        }

        function searchModel(findModel) {
            fetch(`/Item/SearchModel?searchModel=${findModel}`)
                .then(response => response.json())
                .then(data => {
                    showModels.innerHTML = '';
                    data.forEach(model => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.style.cursor = 'pointer';
                        li.textContent = model.modelName + ' - ' + model.marker;

                        li.addEventListener('click', () => {
                            showModels.style.display = 'none';
                            txtSearchModel.value = li.textContent;
                            txtModelId.value = model.id;
                        });
                        showModels.appendChild(li);
                    });
                })
                .catch(error => console.log(error))
        }

        function addModel() {
            const modal = document.getElementById('newModel');
            let model = {
                modelName: txtModel.value,
                marker: txtMarker.value,
                ...(txtCapacityOrSize.value && { capacityOrSize: txtCapacityOrSize.value }),
                ...(cmbMeasurementUnit.value && { measurementUnit: cmbMeasurementUnit.value })
            };

            fetch('/ItemModel/Create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(model)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Modelo guardado correctamente');
                    } else {
                        console.log('Error al guardar');
                    }
                })
                .catch(error => console.error(error))
        }

        //UI
        txtDurationWarranty.addEventListener('input', () => {
            if (txtDurationWarranty.value === '1') {
                cmbTypeWarranty.options[1].text = 'Año';
                cmbTypeWarranty.options[1].value = 'Año';

                cmbTypeWarranty.options[2].text = 'Mes';
                cmbTypeWarranty.options[2].value = 'Mes';
            }
            else {
                cmbTypeWarranty.options[1].text = 'Años';
                cmbTypeWarranty.options[1].value = 'Años';

                cmbTypeWarranty.options[2].text = 'Meses';
                cmbTypeWarranty.options[2].value = 'Meses';
            }
        });
        cbxCapacity.addEventListener('change', () => {
            if (cbxCapacity.checked) {
                capacityDiv.style.display = 'block';
            }
            else {
                capacityDiv.style.display = 'none';
            }
        });
    </script>
}


