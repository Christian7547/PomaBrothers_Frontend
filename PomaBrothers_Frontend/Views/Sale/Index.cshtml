<h1>Ventas</h1>
<hr />

<div>
    <button class="btn btn-success m-4"
            data-toggle="modal"
            data-target="#modalSales">
        Reporte de ventas
    </button>
</div>

<div class="modal fade" id="modalSales">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Reportes de ventas</h5>
            </div>
            <div class="modal-body">
                <p>
                    <div class="row">
                        <div class="col">
                            <button class="btn btn-success"
                                    type="button"
                                    data-toggle="collapse"
                                    data-target="#multiCollapseExample1"
                                    aria-expanded="false"
                                    aria-controls="multiCollapseExample1">
                                Reporte de compras de un cliente
                            </button>
                        </div>
                        <div class="col">
                            <button class="btn btn-success"
                                    type="button"
                                    data-toggle="collapse"
                                    data-target="#multiCollapseExample2"
                                    aria-expanded="false"
                                    aria-controls="multiCollapseExample2">
                                Reporte de ventas por rango de fechas
                            </button>
                        </div>
                    </div>
                </p>
                <div class="row">
                    <div class="collapse multi-collapse" id="multiCollapseExample1">
                        <div class="card card-body">
                            <p>
                                <label for="txtCustomer" class="form-label">Buscar cliente:</label>
                                <input id="txtCustomer" type="text" class="form-control" placeholder="Ingrese el CI del cliente..." />
                                <input id="txtCustomerId" type="hidden" />
                                <ul id="showCustomers"></ul>
                            </p>
                            <div>
                                <input type="submit" class="btn btn-success" data-dismiss="modal" value="Generar reporte" onclick="generatedPdfCustomerPurchases()"  />
                            </div>
                        </div>
                    </div>
                    <p></p>
                    <div class="collapse multi-collapse" id="multiCollapseExample2">
                        <div class="card card-body">
                            <p>
                                <label for="txtStartDate" class="form-label">Desde:</label>
                                <input id="txtStartDate" type="date" class="form-control" placeholder="Seleccione una fecha" />
                            </p>
                            <p>
                                <label for="txtEndDate" class="form-label">Hasta:</label>
                                <input id="txtEndDate" type="date" class="form-control" placeholder="Seleccione una fecha" />
                            </p>
                            <div>
                                <input type="submit" class="btn btn-success" onclick="generatedPdfByDateRange()" value="Generar reporte" data-dismiss="modal" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <table class="table table-bordered" id="tableSales">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Total (Bs.)</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal">
    <div class=" modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="lblDateSale"></h5>
            </div>
            <div class="modal-body">
                <h5 class="fw-bold">Productos:</h5>
                <table class="table table-borderless" id="tableItems">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Garantía</th>
                            <th>Serie</th>
                            <th>Precio (Bs.)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2"></td>
                            <td>
                                <label class="control-label fw-bold">Total:</label>
                            </td>
                            <td>
                                <span id="lblTotal" class="fw-bold"></span>
                                <label class="fw-bold">Bs.</label>
                            </td>
                        </tr>
                    </tfoot>
                </table>
                <hr />
                <div class="row">
                    <div class="col-md-3">
                        <div class="mt-1">
                            <label for="lblClientName" class="fw-bold fs-6">Cliente:</label>
                        </div>
                        <div class="mt-1">
                            <label for="lblCi" class="fw-bold fs-6">Carnet de identidad:</label>
                        </div>
                        <div class="mt-1">
                            <label for="lblEmail" class="fw-bold fs-6">Correo electrónico:</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mt-1">
                            <label id="lblClientName" class="fs-6"></label>
                        </div>
                        <div class="mt-1">
                            <label id="lblCi" fs-6"></label>
                        </div>
                        <div class="mt-1">
                            <label id="lblEmail" class="fs-6"></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center justify-content-center modal-footer">
                <button type="button" class="btn btn-danger w-50" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script>
        const tableSales = document.getElementById('tableSales');

        const tableItems = document.getElementById('tableItems');
        const lblTotal = document.getElementById('lblTotal');
        const lblDateSale = document.getElementById('lblDateSale');
        const lblClientName = document.getElementById('lblClientName');
        const lblEmail = document.getElementById('lblEmail');
        const lblCi = document.getElementById('lblCi');

        const txtCustomer = document.getElementById('txtCustomer');
        const txtCustomerId = document.getElementById('txtCustomerId');
        const showCustomers = document.getElementById('showCustomers');

        const txtStartDate = document.getElementById('txtStartDate');
        const txtEndDate = document.getElementById('txtEndDate');

        document.addEventListener('DOMContentLoaded', () => {
            txtCustomer.addEventListener('input', () => {
                showCustomers.style.display = 'block';
                searchCustomer(txtCustomer.value);
            });
            getSales();
        })

        function getSales() {
            fetch('/Sale/GetSales')
            .then(res => {
                if (res.ok) {
                    return res.json();
                }
            })
            .then(data => {
                showSales(data);    
            })
            .catch(error => console.error(error));
        }

        function showSales(data){
            const tbody = tableSales.getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            for (let i = 0; i < data.length; i++) {
                var row = tbody.insertRow();
                row.insertCell(0).textContent = data[i].registerDate;
                let secondLastName;
                if (data[i].customer.secondLastName === null){
                    secondLastName = '';
                }
                else{
                    secondLastName = data[i].customer.secondLastName;
                }
                row.insertCell(1).textContent = data[i].customer.name + ' ' + data[i].customer.lastName + ' ' + secondLastName;
                row.insertCell(2).textContent = data[i].total;
                var btnDetails = document.createElement('button');
                btnDetails.classList.add('btn', 'btn-success');
                btnDetails.textContent = 'Ver Detalles';
                btnDetails.setAttribute('data-target', '#detailsModal');
                btnDetails.setAttribute('data-toggle', 'modal');
                btnDetails.onclick = () => {
                    showDetailsOfSale(data[i])
                    showItems(data[i].saleDetails);
                }
                row.insertCell(3).appendChild(btnDetails);
            }
        }

        function showDetailsOfSale(sale){
            lblTotal.textContent = sale.total;
            lblDateSale.textContent = `Venta de ${sale.registerDate}`;
            let secondLastName;
            if (sale.customer.secondLastName === null) {
                secondLastName = '';
            }
            else {
                secondLastName = sale.customer.secondLastName;
            }
            lblClientName.textContent = sale.customer.name + ' ' + sale.customer.lastName + ' ' + secondLastName;
            lblEmail.textContent = sale.customer.email;
            lblCi.textContent = sale.customer.ci;
        }

        function showItems(items) {
            const tbody = tableItems.getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            items.forEach(detail => {
                var row = tbody.insertRow();
                row.insertCell(0).textContent = detail.item.name;
                row.insertCell(1).textContent = detail.item.durationWarranty + ' ' + detail.item.typeWarranty;
                row.insertCell(2).textContent = detail.item.serie;
                row.insertCell(3).textContent = detail.item.price;
            });
        }

        function searchCustomer(customer){
            fetch(`/Customer/SearchCustomer?searchCustomer=${customer}`)
            .then(res => res.json())
            .then(data => {
                showCustomers.innerHTML = '';
                data.forEach(customer => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.style.cursor = 'pointer';
                    if (customer.secondLastNameCustomer === null) {
                        li.textContent = customer.nameCustomer + ' ' + customer.lastNameCustomer;
                    }else{
                        li.textContent = customer.nameCustomer + ' ' + customer.lastNameCustomer + ' ' + customer.secondLastNameCustomer;
                    }
                    li.addEventListener('click', () => {
                        showCustomers.style.display = 'none';
                        txtCustomer.value = li.textContent;
                        txtCustomerId.value = customer.id;
                    });
                    showCustomers.appendChild(li);
                });
            })
            .catch(error => console.log(error))
        }

        function generatedPdfCustomerPurchases(){
            let id = txtCustomerId.value;
            fetch(`/SalesReports/GeneratedReportPurchasesCustomer?customerId=${id}`)
            .then(res => {
                if (res.ok && res.headers.get('Content-Type') === 'application/pdf') {
                    return res.blob();
                } else if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error('No se pudo generar el reporte');
                    });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                window.open(url, '_blank');
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error al descargar el archivo: ', error);
                alert(error.message);
            })
        }

        function generatedPdfByDateRange() {
            let startDate = txtStartDate.value;
            let endDate = txtEndDate.value;
            fetch(`/SalesReports/GeneratedReportSalesByDateRange?startDate=${startDate}&finishDate=${endDate}`)
            .then(res => {
                if (res.ok && res.headers.get('Content-Type') === 'application/pdf') {
                    return res.blob();
                } else if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error(text || 'No se pudo generar el reporte');
                    });
                }
            })
            .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    window.open(url, '_blank');
                    window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error al descargar el archivo: ', error);
                alert(error.message);
            })
        }
    </script>
}
